<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Lavish Barber Shop - Loyalty Program</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  body {
    margin: 0;
    background: #0f0f0f;
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    text-align: center;
  }

  h1 {
    margin-top: 30px;
    font-size: 36px;
  }

  h3 {
    margin-bottom: 40px;
    font-weight: normal;
  }

  .circle-container {
    position: relative;
    width: 300px;
    height: 300px;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #progressCircle {
    width: 300px;
    height: 300px;
    border-radius: 50%;
    background: conic-gradient(#00ff88 0deg, #222 0deg);
    display: flex;
    align-items: center;
    justify-content: center;
    position: absolute;
    top: 0;
    left: 0;
  }

  #qrcode {
    position: absolute;
    width: 150px;
    height: 150px;
  }

  #progressText {
    position: absolute;
    bottom: -40px;
    left: 50%;
    transform: translateX(-50%);
    font-size: 24px;
    font-weight: bold;
  }

  #message {
    margin-top: 30px;
    font-size: 20px;
  }

  button {
    margin-top: 30px;
    padding: 12px 25px;
    font-size: 18px;
    background: #00ff88;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }

  button:hover {
    background: #00cc66;
  }
</style>
</head>
<body>

<h1>ðŸ’ˆ Lavish Barber Shop</h1>
<h3>Loyalty Program</h3>

<div class="circle-container">
  <div id="progressCircle"></div>
  <div id="qrcode"></div>
  <div id="progressText">0 / 10</div>
</div>

<p id="message">Scan the QR code each time you get a haircut.</p>

<button onclick="checkIn()">Register Haircut</button>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // User ID
  let userId = localStorage.getItem("lavishUser");
  if (!userId) {
    userId = prompt("Enter your phone number:");
    localStorage.setItem("lavishUser", userId);
  }

  // Shop location
  const shopLat = 31.8457; // Change to your exact latitude
  const shopLng = -102.3676; // Change to your exact longitude

  // Generate QR code
  new QRCode(document.getElementById("qrcode"), {
    text: "https://YOUR_USERNAME.github.io/lavish-loyalty/",
    width: 150,
    height: 150,
    colorDark: "#0f0f0f",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });

  // Update progress circle
  function updateCircle(count) {
    const percent = (count / 10) * 360;
    document.getElementById("progressCircle").style.background =
      `conic-gradient(#00ff88 ${percent}deg, #222 ${percent}deg)`;
    document.getElementById("progressText").innerText = count + " / 10";
  }

  // Register haircut
  async function checkIn() {
    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // Validate user is at the barber shop
      const distance = Math.sqrt(Math.pow(lat - shopLat, 2) + Math.pow(lng - shopLng, 2));
      if (distance > 0.01) {
        alert("You must be at Lavish Barber Shop to register your haircut.");
        return;
      }

      const userRef = db.collection("customers").doc(userId);
      const doc = await userRef.get();
      const now = new Date();

      if (!doc.exists) {
        await userRef.set({ cuts: 1, lastVisit: now });
        updateCircle(1);
        return;
      }

      const data = doc.data();
      const lastVisit = data.lastVisit.toDate();
      const diffDays = (now - lastVisit) / (1000*60*60*24);

      if (diffDays < 5) {
        alert("At least 5 days must pass between haircuts.");
        return;
      }

      let newCuts = data.cuts + 1;

      if (newCuts >= 10) {
        alert("ðŸŽ‰ Free haircut unlocked!");
        await userRef.set({ cuts: 0, lastVisit: now });
        updateCircle(0);
      } else {
        await userRef.set({ cuts: newCuts, lastVisit: now });
        updateCircle(newCuts);
      }
    });
  }

  // Load initial data
  async function loadData() {
    const userRef = db.collection("customers").doc(userId);
    const doc = await userRef.get();
    if (doc.exists) updateCircle(doc.data().cuts);
  }

  loadData();
</script>
</body>
</html>
