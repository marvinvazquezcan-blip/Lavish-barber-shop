<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Lavish Barber Shop - Programa de Fidelidad</title>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<style>
  body {
    margin: 0;
    background: #0f0f0f;
    color: white;
    font-family: Arial, sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    text-align: center;
  }

  h1 {
    margin-top: 30px;
    font-size: 36px;
  }

  h3 {
    margin-bottom: 40px;
    font-weight: normal;
  }

  .circle-container {
    position: relative;
    width: 300px;
    height: 300px;
  }

  #progressCircle {
    width: 300px;
    height: 300px;
    border-radius: 50%;
    background: conic-gradient(#00ff88 0deg, #222 0deg);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  #qrcode {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
  }

  #progressText {
    position: absolute;
    top: 90%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    font-weight: bold;
  }

  #message {
    margin-top: 30px;
    font-size: 20px;
  }

  button {
    margin-top: 30px;
    padding: 12px 25px;
    font-size: 18px;
    background: #00ff88;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
  }

  button:hover {
    background: #00cc66;
  }
</style>
</head>
<body>

<h1>ðŸ’ˆ Lavish Barber Shop</h1>
<h3>Programa de Fidelidad</h3>

<div class="circle-container">
  <div id="progressCircle"></div>
  <div id="qrcode"></div>
  <div id="progressText">0 / 10</div>
</div>

<p id="message">Escanea el QR cada vez que vengas a cortarte el cabello.</p>

<button onclick="checkIn()">Registrar Corte</button>

<script>
  // Firebase configuration
  const firebaseConfig = {
    apiKey: "TU_API_KEY",
    authDomain: "TU_AUTH_DOMAIN",
    projectId: "TU_PROJECT_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Usuario
  let userId = localStorage.getItem("lavishUser");
  if (!userId) {
    userId = prompt("Ingresa tu nÃºmero de telÃ©fono:");
    localStorage.setItem("lavishUser", userId);
  }

  // Coordenadas de la barberÃ­a
  const shopLat = 31.8457; // Cambia por tu latitud exacta
  const shopLng = -102.3676; // Cambia por tu longitud exacta

  // Generar QR
  new QRCode(document.getElementById("qrcode"), {
    text: "https://TU_USUARIO.github.io/lavish-loyalty/",
    width: 150,
    height: 150,
    colorDark: "#0f0f0f",
    colorLight: "#ffffff",
    correctLevel: QRCode.CorrectLevel.H
  });

  // Actualizar cÃ­rculo
  function updateCircle(count) {
    const percent = (count / 10) * 360;
    document.getElementById("progressCircle").style.background =
      `conic-gradient(#00ff88 ${percent}deg, #222 ${percent}deg)`;
    document.getElementById("progressText").innerText = count + " / 10";
  }

  // Registrar corte
  async function checkIn() {
    navigator.geolocation.getCurrentPosition(async position => {
      const lat = position.coords.latitude;
      const lng = position.coords.longitude;

      // ValidaciÃ³n de ubicaciÃ³n (aprox 1 km)
      const distance = Math.sqrt(Math.pow(lat - shopLat, 2) + Math.pow(lng - shopLng, 2));
      if (distance > 0.01) {
        alert("Debes estar en Lavish Barber Shop para registrar tu corte.");
        return;
      }

      const userRef = db.collection("customers").doc(userId);
      const doc = await userRef.get();
      const now = new Date();

      if (!doc.exists) {
        await userRef.set({
          cuts: 1,
          lastVisit: now
        });
        updateCircle(1);
        return;
      }

      const data = doc.data();
      const lastVisit = data.lastVisit.toDate();
      const diffDays = (now - lastVisit) / (1000*60*60*24);

      if (diffDays < 5) {
        alert("Deben pasar al menos 5 dÃ­as entre cortes.");
        return;
      }

      let newCuts = data.cuts + 1;

      if (newCuts >= 10) {
        alert("ðŸŽ‰ Â¡Corte GRATIS desbloqueado!");
        await userRef.set({ cuts: 0, lastVisit: now });
        updateCircle(0);
      } else {
        await userRef.set({ cuts: newCuts, lastVisit: now });
        updateCircle(newCuts);
      }
    });
  }

  // Cargar datos iniciales
  async function loadData() {
    const userRef = db.collection("customers").doc(userId);
    const doc = await userRef.get();
    if (doc.exists) updateCircle(doc.data().cuts);
  }

  loadData();
</script>
</body>
</html>
